<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>JMM内存模型和happens-before规则 | chew's blog</title><meta name="description" content="JMM内存模型和happens-before规则"><meta name="keywords" content="笔记,JMM,happens-before规则"><meta name="author" content="chew"><meta name="copyright" content="chew"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JMM内存模型和happens-before规则"><meta name="twitter:description" content="JMM内存模型和happens-before规则"><meta name="twitter:image" content="http://facai1983.top/img/JMM.png"><meta property="og:type" content="article"><meta property="og:title" content="JMM内存模型和happens-before规则"><meta property="og:url" content="http://facai1983.top/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/"><meta property="og:site_name" content="chew's blog"><meta property="og:description" content="JMM内存模型和happens-before规则"><meta property="og:image" content="http://facai1983.top/img/JMM.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://facai1983.top/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/"><link rel="prev" title="并发编程三大特性" href="http://facai1983.top/2020/02/01/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%89%E5%A4%A7%E7%89%B9%E6%80%A7/"><link rel="next" title="分布式:CAP原则" href="http://facai1983.top/2020/02/01/%E5%88%86%E5%B8%83%E5%BC%8F-CAP%E5%8E%9F%E5%88%99/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">chew's blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-link"></i><span> Picture</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/default.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">90</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">95</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">88</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-link"></i><span> Picture</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#一-并发编程中面临两个问题"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">一 并发编程中面临两个问题</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-线程之间如何通信；"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">1. 线程之间如何通信；</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">2.线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二-JMM内存模型"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">二 JMM内存模型</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-共享变量"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">1.共享变量</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-JMM内存模型"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">2.JMM内存模型</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#三-重排序"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">三 重排序</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-为什么要重排序"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">1.为什么要重排序</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-什么情况下不能进行重排序"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">2.什么情况下不能进行重排序</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-as-if-serial语义"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">3.as-if-serial语义</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#四-happens-before规则"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">四 happens-before规则</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-什么是happens-before"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">1.什么是happens-before</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-具体语义"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">2.具体语义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-和as-if-serial的区别"><span class="toc_mobile_items-number">4.3.</span> <span class="toc_mobile_items-text">2.和as-if-serial的区别</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-并发编程中面临两个问题"><span class="toc-number">1.</span> <span class="toc-text">一 并发编程中面临两个问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-线程之间如何通信；"><span class="toc-number">1.1.</span> <span class="toc-text">1. 线程之间如何通信；</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。"><span class="toc-number">1.2.</span> <span class="toc-text">2.线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-JMM内存模型"><span class="toc-number">2.</span> <span class="toc-text">二 JMM内存模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-共享变量"><span class="toc-number">2.1.</span> <span class="toc-text">1.共享变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-JMM内存模型"><span class="toc-number">2.2.</span> <span class="toc-text">2.JMM内存模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-重排序"><span class="toc-number">3.</span> <span class="toc-text">三 重排序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-为什么要重排序"><span class="toc-number">3.1.</span> <span class="toc-text">1.为什么要重排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-什么情况下不能进行重排序"><span class="toc-number">3.2.</span> <span class="toc-text">2.什么情况下不能进行重排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-as-if-serial语义"><span class="toc-number">3.3.</span> <span class="toc-text">3.as-if-serial语义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-happens-before规则"><span class="toc-number">4.</span> <span class="toc-text">四 happens-before规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-什么是happens-before"><span class="toc-number">4.1.</span> <span class="toc-text">1.什么是happens-before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-具体语义"><span class="toc-number">4.2.</span> <span class="toc-text">2.具体语义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-和as-if-serial的区别"><span class="toc-number">4.3.</span> <span class="toc-text">2.和as-if-serial的区别</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(http://facai1983.top/img/JMM.png)"><div id="post-info"><div id="post-title"><div class="posttitle">JMM内存模型和happens-before规则</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2020-02-01<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2020-02-01</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a><i class="fa fa-angle-right fa-fw" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E9%9D%A2%E8%AF%95/JMM/">JMM</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>comments:</span><a href="/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="一-并发编程中面临两个问题"><a href="#一-并发编程中面临两个问题" class="headerlink" title="一 并发编程中面临两个问题"></a>一 并发编程中面临两个问题</h2><p>在并发编程中主要需要解决两个问题：</p>
<h3 id="1-线程之间如何通信；"><a href="#1-线程之间如何通信；" class="headerlink" title="1. 线程之间如何通信；"></a>1. 线程之间如何通信；</h3><h3 id="2-线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。"><a href="#2-线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。" class="headerlink" title="2.线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。"></a>2.线程之间如何完成同步（这里的线程指的是并发执行的活动实体）。</h3><p>通信是指线程之间以何种机制来交换信息，主要有两种：共享内存和消息传递。java内存模型是<strong>共享内存的并发模型</strong>，线程之间主要通过读-写共享变量来完成隐式通信。如果程序员不能理解Java的共享内存模型在编写并发程序时一定会遇到各种各样关于内存可见性的问题。</p>
<h2 id="二-JMM内存模型"><a href="#二-JMM内存模型" class="headerlink" title="二 JMM内存模型"></a>二 JMM内存模型</h2><h3 id="1-共享变量"><a href="#1-共享变量" class="headerlink" title="1.共享变量"></a>1.共享变量</h3><p>在java程序中所有<strong>实例域，静态域和数组元素</strong>都是放在堆内存中（所有线程均可访问到，是可以共享的），而局部变量，方法定义参数和异常处理器参数不会在线程间共享。共享数据会出现线程安全的问题，而非共享数据不会出现线程安全的问题。</p>
<h3 id="2-JMM内存模型"><a href="#2-JMM内存模型" class="headerlink" title="2.JMM内存模型"></a>2.JMM内存模型</h3><p>我们知道CPU的处理速度和主存的读写速度不是一个量级的，为了平衡这种巨大的差距，每个CPU都会有缓存。因此，共享变量会先放在主存中，每个线程都有属于自己的工作内存，并且会把位于主存中的共享变量拷贝到自己的工作内存，之后的读写操作均使用位于工作内存的变量副本，并在某个时刻将工作内存的变量副本写回到主存中去。JMM就从抽象层次定义了这种方式，并且JMM决定了一个线程对共享变量的写入何时对其他线程是可见的。</p>
<a href="/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/JMM.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" title="JMM" data-src="/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/JMM.png"></a>

<p>如图为JMM抽象示意图，线程A和线程B之间要完成通信的话，要经历如下两步：</p>
<ol>
<li>线程A从主内存中将共享变量读入线程A的工作内存后并进行操作，之后将数据重新写回到主内存中；</li>
<li>线程B从主存中读取最新的共享变量</li>
</ol>
<p>从横向去看看，线程A和线程B就好像通过共享变量在进行隐式通信。这其中有很有意思的问题，如果线程A更新后数据并没有及时写回到主存，而此时线程B读到的是过期的数据，这就出现了“脏读”现象。可以通过同步机制（控制不同线程间操作发生的相对顺序）来解决或者通过volatile关键字使得每次volatile变量都能够强制刷新到主存，从而对每个线程都是可见的。</p>
<h2 id="三-重排序"><a href="#三-重排序" class="headerlink" title="三 重排序"></a>三 重排序</h2><h3 id="1-为什么要重排序"><a href="#1-为什么要重排序" class="headerlink" title="1.为什么要重排序"></a>1.为什么要重排序</h3><p>一个好的内存模型实际上会放松对处理器和编译器规则的束缚，也就是说软件技术和硬件技术都为同一个目标而进行奋斗：在不改变程序执行结果的前提下，尽可能提高并行度。JMM对底层尽量减少约束，使其能够发挥自身优势。因此，在执行程序时，<strong>为了提高性能，编译器和处理器常常会对指令进行重排序</strong>。一般重排序可以分为如下三种：</p>
<a href="/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/as-if-serial.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img class="lazyload" title="as-if-serial" data-src="/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/as-if-serial.png"></a>

<ol>
<li>编译器优化的重排序。编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序；</li>
<li>指令级并行的重排序。现代处理器采用了指令级并行技术来将多条指令重叠执行。如果<strong>不存在数据依赖性</strong>，处理器可以改变语句对应机器指令的执行顺序；</li>
<li>内存系统的重排序。由于处理器使用缓存和读/写缓冲区，这使得加载和存储操作看上去可能是在乱序执行的。</li>
</ol>
<p>如图，1属于编译器重排序，而2和3统称为处理器重排序。这些重排序会导致线程安全的问题，一个很经典的例子就是DCL问题，这个在以后的文章中会具体去聊。<strong>针对编译器重排序</strong>，JMM的编译器重排序规则会禁止一些<strong>特定类型的编译器重排序</strong>；<strong>针对处理器重排序</strong>，编译器在生成指令序列的时候会通过<strong>插入内存屏障指令来禁止某些特殊的处理器重排序</strong>。</p>
<h3 id="2-什么情况下不能进行重排序"><a href="#2-什么情况下不能进行重排序" class="headerlink" title="2.什么情况下不能进行重排序"></a>2.什么情况下不能进行重排序</h3><p>那么什么情况下，不能进行重排序了？下面就来说说数据依赖性。有如下代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> pi = <span class="number">3.14</span> <span class="comment">//A</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> r = <span class="number">1.0</span> <span class="comment">//B</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> area = pi * r * r <span class="comment">//C</span></span><br></pre></td></tr></table></figure></div>

<p>这是一个计算圆面积的代码，由于A,B之间没有任何关系，对最终结果也不会存在关系，它们之间执行顺序可以重排序。因此可以执行顺序可以是A-&gt;B-&gt;C或者B-&gt;A-&gt;C执行最终结果都是3.14，即A和B之间没有数据依赖性。具体的定义为：<strong>如果两个操作访问同一个变量，且这两个操作有一个为写操作，此时这两个操作就存在数据依赖性</strong>这里就存在三种情况：1. 读后写；2.写后写；3. 写后读，者三种操作都是存在数据依赖性的，如果重排序会对最终执行结果会存在影响。<strong>编译器和处理器在重排序时，会遵守数据依赖性，编译器和处理器不会改变存在数据依赖性关系的两个操作的执行顺序</strong></p>
<h3 id="3-as-if-serial语义"><a href="#3-as-if-serial语义" class="headerlink" title="3.as-if-serial语义"></a>3.as-if-serial语义</h3><p>as-if-serial语义的意思是：不管怎么重排序（编译器和处理器为了提供并行度），（单线程）程序的执行结果不能被改变。编译器，runtime和处理器都必须遵守as-if-serial语义。as-if-serial语义把单线程程序保护了起来，<strong>遵守as-if-serial语义的编译器，runtime和处理器共同为编写单线程程序的程序员创建了一个幻觉：单线程程序是按程序的顺序来执行的</strong>。比如上面计算圆面积的代码，在单线程中，会让人感觉代码是一行一行顺序执行上，实际上A,B两行不存在数据依赖性可能会进行重排序，即A，B不是顺序执行的。as-if-serial语义使程序员不必担心单线程中重排序的问题干扰他们，也无需担心内存可见性问题。</p>
<h2 id="四-happens-before规则"><a href="#四-happens-before规则" class="headerlink" title="四 happens-before规则"></a>四 happens-before规则</h2><h3 id="1-什么是happens-before"><a href="#1-什么是happens-before" class="headerlink" title="1.什么是happens-before"></a>1.什么是happens-before</h3><p>JMM可以通过happens-before关系向程序员提供跨线程的内存可见性保证（如果A线程的写操作a与B线程的读操作b之间存在happens-before关系，尽管a操作和b操作在不同的线程中执行，但JMM向程序员保证a操作将对b操作可见）。</p>
<h3 id="2-具体语义"><a href="#2-具体语义" class="headerlink" title="2.具体语义"></a>2.具体语义</h3><p>1）如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。</p>
<p>2）两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须要按照happens-before关系指定的顺序来执行。如果重排序之后的执行结果，与按happens-before关系来执行的结果一致，那么这种重排序并不非法（也就是说，JMM允许这种重排序）。</p>
<p>上面的<strong>1）是JMM对程序员的承诺</strong>。从程序员的角度来说，可以这样理解happens-before关系：如果A happens-before B，那么Java内存模型将向程序员保证——A操作的结果将对B可见，且A的执行顺序排在B之前。注意，这只是Java内存模型向程序员做出的保证！</p>
<p>上面的<strong>2）是JMM对编译器和处理器重排序的约束原则</strong>。正如前面所言，JMM其实是在遵循一个基本原则：只要不改变程序的执行结果（指的是单线程程序和正确同步的多线程程序），编译器和处理器怎么优化都行。JMM这么做的原因是：程序员对于这两个操作是否真的被重排序并不关心，程序员关心的是程序执行时的语义不能被改变（即执行结果不能被改变）。因此，happens-before关系本质上和as-if-serial语义是一回事。</p>
<h3 id="2-和as-if-serial的区别"><a href="#2-和as-if-serial的区别" class="headerlink" title="2.和as-if-serial的区别"></a>2.和as-if-serial的区别</h3><ol>
<li>as-if-serial语义保证单线程内程序的执行结果不被改变，happens-before关系保证正确同步的多线程程序的执行结果不被改变。</li>
<li>as-if-serial语义给编写单线程程序的程序员创造了一个幻境：单线程程序是按程序的顺序来执行的。happens-before关系给编写正确同步的多线程程序的程序员创造了一个幻境：正确同步的多线程程序是按happens-before指定的顺序来执行的。</li>
<li>as-if-serial语义和happens-before这么做的目的，都是为了在不改变程序执行结果的前提下，尽可能地提高程序执行的并行度。</li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">chew</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://facai1983.top/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/">http://facai1983.top/2020/02/01/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8Chappens-before%E8%A7%84%E5%88%99/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记    </a><a class="post-meta__tags" href="/tags/JMM/">JMM    </a><a class="post-meta__tags" href="/tags/happens-before%E8%A7%84%E5%88%99/">happens-before规则    </a></div><div class="post_share"><div class="social-share" data-image="http://facai1983.top/img/JMM.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.png" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/02/01/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%89%E5%A4%A7%E7%89%B9%E6%80%A7/"><img class="prev_cover lazyload" data-src="http://facai1983.top/img/multithreading.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>并发编程三大特性</span></div></a></div><div class="next-post pull_right"><a href="/2020/02/01/%E5%88%86%E5%B8%83%E5%BC%8F-CAP%E5%8E%9F%E5%88%99/"><img class="next_cover lazyload" data-src="http://facai1983.top/img/CAP.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>分布式:CAP原则</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/24/浏览器在输入URL回车之后都发生了什么/" title="浏览器在输入URL回车之后都发生了什么"><img class="relatedPosts_cover lazyload"data-src="http://facai1983.top/img/http.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-01</div><div class="relatedPosts_title">浏览器在输入URL回车之后都发生了什么</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/05/栈与队列的区别，阻塞队列/" title="栈与队列的区别，阻塞队列"><img class="relatedPosts_cover lazyload"data-src="http://facai1983.top/img/writing.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-01</div><div class="relatedPosts_title">栈与队列的区别，阻塞队列</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/06/解决事务一致性的方案/" title="解决事务一致性的方案"><img class="relatedPosts_cover lazyload"data-src="https://bkimg.cdn.bcebos.com/pic/738b4710b912c8fc8cb9b347f6039245d78821f5@wm_1,g_7,k_d2F0ZXIvYmFpa2U4MA==,xp_5,yp_5"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-01</div><div class="relatedPosts_title">解决事务一致性的方案</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/06/使用LCN实现分布式事务一致性1/" title="使用LCN实现分布式事务一致性"><img class="relatedPosts_cover lazyload"data-src="https://bkimg.cdn.bcebos.com/pic/738b4710b912c8fc8cb9b347f6039245d78821f5@wm_1,g_7,k_d2F0ZXIvYmFpa2U4MA==,xp_5,yp_5"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-01</div><div class="relatedPosts_title">使用LCN实现分布式事务一致性</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/07/使用LCN实现分布式事务一致性/" title="实操——使用LCN实现分布式事务一致性"><img class="relatedPosts_cover lazyload"data-src="http://facai1983.top/img/一致性.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-01</div><div class="relatedPosts_title">实操——使用LCN实现分布式事务一致性</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/10/关于Redis/" title="关于Redis"><img class="relatedPosts_cover lazyload"data-src="http://facai1983.top/img/redis.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-01</div><div class="relatedPosts_title">关于Redis</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'jbVBGNiWBwRavzd2W1J9xR0l-gzGzoHsz',
  appKey:'5O4E9wX4KIBNWRdKriSVX6mY',
  placeholder:'Please leave your footprints',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By chew</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>